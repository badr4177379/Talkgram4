<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Talkgram (WhatsApp Clone)</title>
    <style>
        :root {
            --whatsapp-dark-green: #075E54;
            --whatsapp-light-green: #25D366;
            --whatsapp-teal-green: #128C7E;
            --whatsapp-chat-bg-light: #E5DDD5;
            --whatsapp-chat-bg-dark: #0b141a;
            --whatsapp-outgoing-bubble: #DCF8C6;
            --whatsapp-incoming-bubble: #FFFFFF;
            --whatsapp-text-primary: #111B21;
            --whatsapp-text-secondary: #667781;
            --whatsapp-text-white: #FFFFFF;
            --whatsapp-border-light: #f0f0f0; 
            --whatsapp-background-default: #FFFFFF;
            --whatsapp-background-app: #f0f2f5; 
            --system-message-bg: #E1F3FB; 
            --input-bar-bg: #F0F2F5; 
        }

        body {
            font-family: "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--whatsapp-background-app);
            color: var(--whatsapp-text-primary);
            direction: rtl;
            overscroll-behavior-y: contain; 
            height: 100vh; 
            overflow: hidden; 
        }

        .page {
            display: none; 
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            background-color: var(--whatsapp-background-default);
            flex-direction: column; 
        }
        .page.active {
            display: flex; 
        }
        #welcomePage, #registerPage, #loginPage, 
        #chatsPage .tab-content,
        #settingsTabContent .settings-content,
        #createGroupModal .members-selection-container
         {
            overflow-y: auto;
        }


        #welcomePage {
            justify-content: center;
            align-items: center;
            background-color: var(--whatsapp-background-app);
        }
        #registerPage, #loginPage {
             background-color: var(--whatsapp-background-app);
        }


        .app-header {
            background-color: var(--whatsapp-dark-green);
            color: white;
            padding: 0 8px 0 12px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px; 
            min-height: 56px;
            box-sizing: border-box;
            flex-shrink: 0; 
        }
        .app-header .back-button, .app-header .actions button {
            background: none; border: none; color: white;
            font-size: 24px; cursor: pointer; padding: 12px;
        }
        .app-header .header-content {
            display: flex; align-items: center; flex-grow: 1; overflow: hidden;
            margin: 0 8px; 
        }
        .app-header .header-avatar img {
            width: 40px; height: 40px; border-radius: 50%;
            margin-left: 8px; margin-right: 8px; 
        }
        .app-header .header-info {
            display: flex; flex-direction: column; align-items: flex-start; 
            overflow: hidden;
        }
        .app-header .title {
            font-size: 18px; font-weight: 500; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        #chatsPage .app-header .title { font-size: 20px; }

        .app-header .subtitle {
            font-size: 12px; color: rgba(255, 255, 255, 0.8); white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .app-header .actions { display: flex; align-items: center; }
        .app-header .actions button { margin-left: 0; margin-right: 4px; } 


        .tabs {
            display: flex; background-color: var(--whatsapp-dark-green);
            color: rgba(255, 255, 255, 0.7); 
            height: 48px; min-height: 48px;
            flex-shrink: 0;
        }
        .tab-item {
            flex: 1; display: flex; justify-content: center; align-items: center;
            font-size: 14px; font-weight: bold; text-transform: uppercase; cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s;
            padding: 0 5px; 
        }
        .tab-item.active { color: white; border-bottom-color: white; }
        .tab-item .icon { font-size: 20px; margin-left: 5px;} 
        .tab-item.icon-only .icon { margin-left: 0; }


        .auth-content-container {
            padding: 24px; width: 100%; max-width: 450px;
            margin: 0 auto; text-align: center; flex-grow: 1;
            display: flex; flex-direction: column; justify-content: center;
        }
         #registerPage .auth-content-container, #loginPage .auth-content-container {
            padding-top: 20px; 
         }

        #welcomePage .welcome-inner { padding: 20px; text-align: center; }
        .logo {
            width: 100px; height: 100px; background-color: var(--whatsapp-light-green);
            border-radius: 20px; display: flex; justify-content: center; align-items: center;
            margin: 0 auto 40px auto; font-size: 36px; color: white; font-weight: bold;
        }
        #welcomePage h1 { font-size: 28px; color: var(--whatsapp-text-primary); margin-bottom: 12px; font-weight: 600; }
        #welcomePage p.tagline {
            font-size: 16px; color: var(--whatsapp-text-secondary); line-height: 1.6;
            margin-bottom: 50px; max-width: 300px; margin-left: auto; margin-right: auto;
        }
        .agree-button {
            background-color: var(--whatsapp-light-green); color: white; padding: 14px 20px;
            border-radius: 25px; font-size: 16px; font-weight: 600; border: none;
            width: 100%; max-width: 300px; margin: 0 auto 15px auto; display: block; text-decoration: none;
            cursor: pointer;
        }
        .agree-button.secondary { background-color: transparent; color: var(--whatsapp-light-green); }
        #welcomePage .privacy-link { font-size: 13px; color: var(--whatsapp-text-secondary); margin-top: 30px; cursor: pointer; text-decoration: none;}
        #welcomePage .privacy-link:hover { text-decoration: underline;}


        .auth-form h2 { font-size: 20px; color: var(--whatsapp-dark-green); margin-bottom: 30px; font-weight: 600; }
        .input-group { margin-bottom: 18px; text-align: right; } 
        .input-field {
            width: 100%; padding: 14px 16px; border: 1px solid #DADADA; border-radius: 8px;
            font-size: 16px; box-sizing: border-box; background-color: #F6F6F6; color: var(--whatsapp-text-primary);
            outline: none;
        }
        .input-field::placeholder { color: var(--whatsapp-text-secondary); }
        .input-field:focus { border-color: var(--whatsapp-light-green); background-color: white; box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2); }
        .input-field#username, .input-field#loginIdentifier.username-style {
            direction: ltr; 
            text-align: left;
        }
        .input-field#username::placeholder, .input-field#loginIdentifier.username-style::placeholder {
            text-align: right; 
        }
        .field-note { font-size: 12px; color: var(--whatsapp-text-secondary); margin-top: 5px; text-align: right; } 
        .auth-action-button {
            background-color: var(--whatsapp-light-green); color: white; padding: 14px 20px; border-radius: 25px;
            font-size: 16px; font-weight: 600; width: 100%; border: none; margin-top: 20px; cursor: pointer;
        }
        .auth-form .link-style { font-size: 14px; color: var(--whatsapp-dark-green); margin-top: 25px; cursor: pointer; text-decoration: none;}
        .auth-form .link-style:hover {text-decoration: underline;}


        #chatsPage { background-color: var(--whatsapp-background-default); display: flex; flex-direction: column; }
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; } 
        .tab-content.active { display: block; } 

        .chat-list-page-content { 
            flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; 
        }
        .search-bar-container {
            padding: 8px 16px; background-color: var(--whatsapp-background-default);
            border-bottom: 1px solid var(--whatsapp-border-light); flex-shrink: 0;
        }
        .search-input-wrapper {
            background-color: var(--whatsapp-background-app);
            border-radius: 20px; display: flex; align-items: center; padding: 6px 12px;
        }
        .search-input-wrapper input {
            flex-grow: 1; border: none; outline: none; background-color: transparent;
            font-size: 15px; margin-right: 8px; 
        }
        .search-input-wrapper .search-icon { color: var(--whatsapp-text-secondary); }

        .chat-list-container { padding: 0; }
        .chat-item {
            display: flex; align-items: center; padding: 10px 16px;
            border-bottom: 1px solid var(--whatsapp-border-light); cursor: pointer;
        }
        .chat-item:last-child { border-bottom: none; }
        .chat-item:hover { background-color: #f5f5f5; }
        .chat-item .avatar img { width: 48px; height: 48px; border-radius: 50%; margin-left: 16px; object-fit: cover; } 
        .chat-content { flex-grow: 1; overflow: hidden; padding-right: 8px; } 
        .chat-name-time { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .chat-name { font-size: 17px; font-weight: 400; color: var(--whatsapp-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { font-size: 12px; color: var(--whatsapp-text-secondary); flex-shrink: 0; }
        .last-message-line { display: flex; align-items: center; font-size: 14px; color: var(--whatsapp-text-secondary); }
        .last-message { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .unread-badge {
            background-color: var(--whatsapp-light-green); color: white; font-size: 12px;
            padding: 1px 6px; border-radius: 12px; font-weight: 500; margin-left: 8px; flex-shrink: 0; 
        }


        #chatDetailPage { 
            background-color: var(--whatsapp-chat-bg-light);
            background-size: contain; 
        }
        .messages-container { 
            flex-grow: 1; padding: 12px; overflow-y: auto; display: flex; flex-direction: column;
            margin-bottom: 0; 
            transition: margin-bottom 0.2s ease-out; 
        }
        .message-bubble {
            max-width: 75%; padding: 7px 12px; border-radius: 8px; margin-bottom: 4px;
            word-wrap: break-word; line-height: 1.4; font-size: 14.5px;
            position: relative; box-shadow: 0 1px 0.5px rgba(11,20,26,0.13);
        }
        .message-bubble.has-image { padding: 5px; } 
        .message-bubble .message-image {
            max-width: 100%; 
            max-height: 300px; 
            border-radius: 6px; 
            display: block; 
            margin-bottom: 5px; 
            object-fit: cover; 
            cursor: pointer; 
        }
        .message-bubble .text { margin-bottom: 20px; }
        .message-bubble .text.caption-for-image { 
            font-size: 13px;
            color: var(--whatsapp-text-secondary);
            margin-top: 5px; 
            margin-bottom: 20px; 
        }

        .message-bubble .meta {
            font-size: 11px; color: var(--whatsapp-text-secondary); position: absolute;
            bottom: 5px; right: 8px; display: flex; align-items: center; 
        }
        .message-bubble.outgoing .meta { color: rgba(0,0,0,0.45); }
        .message-bubble.outgoing {
            background-color: var(--whatsapp-outgoing-bubble); align-self: flex-start; 
            border-top-left-radius: 0; margin-left: auto;
        }
        .message-bubble.incoming {
            background-color: var(--whatsapp-incoming-bubble); align-self: flex-end; 
            border-top-right-radius: 0; margin-right: auto;
        }
        .message-bubble.incoming .meta { left: 8px; right: auto; } 
        .message-bubble .read-ticks { font-size: 14px; margin-left: 4px; color: #53bdeb; } 
        .message-bubble.outgoing .read-ticks.sent { color: var(--whatsapp-text-secondary); }
        .message-bubble.outgoing .read-ticks.delivered { color: var(--whatsapp-text-secondary); }

        .system-message {
            align-self: center; background-color: var(--system-message-bg); color: #585F63;
            font-size: 12.5px; padding: 6px 10px; border-radius: 8px; margin: 10px 0;
            max-width: 80%; text-align: center;
        }

        .chat-input-bar { 
            display: flex; align-items: flex-end; padding: 8px 12px;
            background-color: var(--input-bar-bg);
            border-top: 1px solid var(--whatsapp-border-light);
            flex-shrink: 0;
        }
        .chat-input-bar .actions-left button, .chat-input-bar .actions-right button {
            background: none; border: none; color: var(--whatsapp-text-secondary);
            font-size: 24px; cursor: pointer; padding: 8px;
        }
        .chat-input-wrapper {
            flex-grow: 1; background-color: var(--whatsapp-background-default);
            border-radius: 20px; padding: 8px 12px; margin: 0 8px;
            display: flex; align-items: center;
        }
        .chat-input-wrapper textarea {
            flex-grow: 1; border: none; outline: none; background-color: transparent;
            font-size: 15px; resize: none; max-height: 100px; line-height: 1.4;
        }
        .chat-input-bar .send-button {
            background-color: var(--whatsapp-dark-green); color: white;
            width: 44px; height: 44px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; border: none; cursor: pointer;
            flex-shrink: 0;
        }
        .emoji-picker {
            height: 200px; 
            background-color: var(--whatsapp-background-app); 
            border-top: 1px solid var(--whatsapp-border-light);
            padding: 10px;
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); 
            gap: 5px; 
            overflow-y: auto; 
            flex-shrink: 0; 
            box-sizing: border-box;
        }
        .emoji-picker span {
            font-size: 22px; 
            cursor: pointer;
            padding: 4px;
            text-align: center;
            border-radius: 5px;
            user-select: none; 
        }
        .emoji-picker span:hover {
            background-color: #e0e0e0;
        }


        /* --- Status Feature Styles --- */
        #statusTabContent { 
        }
        .status-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--whatsapp-border-light);
        }
         .status-section:last-of-type { border-bottom: none; } 

        .status-section h4 {
            font-size: 14px;
            color: var(--whatsapp-dark-green);
            margin: 0 0 10px 0;
            font-weight: 500;
        }
        .status-item {
            display: flex; align-items: center; padding: 8px 0; cursor: pointer;
        }
        .status-item:hover { background-color: #f5f5f5; }
        .status-avatar-wrapper { position: relative; margin-left: 16px; } 
        .status-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .status-avatar-ring {
            position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px;
            border-radius: 50%; border: 2.5px solid var(--whatsapp-light-green);
        }
        .status-avatar-ring.viewed { border-color: #bdc3c7; }
        .status-item-my .status-avatar-ring { border-style: dashed; border-color: #bdc3c7; }
        .status-item-my.has-status .status-avatar-ring { border-style: solid; border-color: var(--whatsapp-light-green); }
        .status-item-my.has-status.all-viewed .status-avatar-ring { border-color: #bdc3c7; } 

        .status-add-icon {
            position:absolute; bottom:0; right:-5px; 
            background-color:var(--whatsapp-light-green); color:white;
            width:20px; height:20px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:14px; font-weight: bold; border:2px solid white;
        }
        .status-info { flex-grow: 1; padding-right: 8px; } 
        .status-name { font-size: 17px; font-weight: 400; color: var(--whatsapp-text-primary); }
        .status-time { font-size: 14px; color: var(--whatsapp-text-secondary); display: block; }

        /* Create Status Modal & Viewer Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--whatsapp-background-default); padding: 20px;
            border-radius: 8px; width: 90%; max-width: 400px;
            text-align: right; 
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; 
            max-height: 90vh; 
        }
        .modal-content h3 { margin-top: 0; color: var(--whatsapp-dark-green); flex-shrink: 0; }
        .modal-content textarea#statusText {
            width: 100%; min-height: 100px; padding: 10px;
            border: 1px solid #ccc; border-radius: 5px;
            margin-bottom: 15px; font-size: 16px; box-sizing: border-box;
            flex-shrink: 0;
        }
        .modal-content .image-preview {
            max-width: 100%; max-height: 200px; margin-bottom: 10px;
            border: 1px solid #eee; display: block;
            margin-left: auto; margin-right: auto;
            flex-shrink: 0;
        }
         .modal-content .file-input-button {
            background-color: var(--whatsapp-teal-green); color: white;
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            display: inline-block; margin-bottom: 10px;
            flex-shrink: 0;
        }
        .modal-buttons { margin-top: 20px; text-align: left; flex-shrink: 0; } 
        .modal-buttons button {
            padding: 10px 20px; margin-right: 10px; 
            border: none; border-radius: 5px; cursor: pointer; font-weight: 500;
        }
        .modal-buttons .post-status-btn, 
        .modal-buttons .create-group-btn { background-color: var(--whatsapp-light-green); color: white; }
         .modal-buttons button:first-child { margin-right: 0; } 

        #statusViewerModal { background-color: #000; }
        .status-viewer-content {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; position: relative;
        }
        .status-viewer-header {
            position: absolute; top: 0; left: 0; right: 0; padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            display: flex; align-items: center; z-index: 10;
        }
        .status-viewer-header img { width: 35px; height: 35px; border-radius: 50%; margin-left: 10px;} 
        .status-viewer-header .name-time .name { font-size: 16px; font-weight: bold;}
        .status-viewer-header .name-time .time { font-size: 12px; color: #eee;}
        .status-viewer-close {
            position: absolute; top: 15px; right: 15px; 
            font-size: 28px; color: white; cursor: pointer; background: none; border: none;
            z-index: 10; padding: 5px;
        }
        .status-viewer-media { max-width: 95%; max-height: 80%; object-fit: contain; }
        .status-viewer-text {
            font-size: 28px; padding: 30px; text-align: center; word-break: break-word;
            background-color: var(--whatsapp-teal-green); min-width: 250px; min-height: 150px;
            display:flex; align-items:center; justify-content:center;
            border-radius: 8px; max-width: 90%;
        }
        .status-progress-bars {
            position: absolute; top: 5px; left: 10px; right: 10px;
            display: flex; gap: 3px; z-index: 10;
        }
        .status-progress-bar {
            flex-grow: 1; height: 3px; background-color: rgba(255,255,255,0.3); border-radius: 2px;
        }
        .status-progress-bar .progress {
            height: 100%; width: 0%; background-color: white; border-radius: 2px;
            transition: width 0.1s linear;
        }
        .status-nav {
            position: absolute; top: 0; bottom: 0; width: 30%; cursor: pointer; z-index: 5;
        }
        .status-nav.prev { left: 0; }
        .status-nav.next { right: 0; }
        .status-viewer-caption {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 15px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
            color: white; font-size: 15px; text-align: center; z-index: 10;
            max-height: 30%; overflow-y: auto;
        }

        /* --- Settings Content (within Tab) Styles --- */
        #settingsTabContent .settings-content { 
            background-color: var(--whatsapp-background-app);
            flex-grow: 1; 
        }
        .settings-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            cursor: pointer;
            background-color: var(--whatsapp-background-default);
        }
        #settingsTabContent .settings-content > .settings-item:not(:last-child) {
             border-bottom: 1px solid var(--whatsapp-border-light);
        }
        #settingsTabContent .settings-content > .settings-item:first-child { 
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .settings-item-avatar-wrapper { margin-left: 16px; } 
        .settings-user-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .settings-item-info { flex-grow: 1; display: flex; flex-direction: column; }
        .settings-user-name { font-size: 18px; font-weight: 500; color: var(--whatsapp-text-primary); }
        .settings-user-status { font-size: 14px; color: var(--whatsapp-text-secondary); }
        .settings-item-action-icon { font-size: 24px; color: var(--whatsapp-dark-green); padding: 8px; }

        .settings-item:hover { background-color: #f9f9f9; }
        .settings-icon {
            font-size: 20px; color: var(--whatsapp-text-secondary);
            margin-left: 24px; 
            width: 24px; text-align: center;
        }
        .settings-text { font-size: 16px; color: var(--whatsapp-text-primary); flex-grow: 1; }
        .settings-subtext { font-size: 13px; color: var(--whatsapp-text-secondary); margin-top: 2px; display: block; }

        .settings-divider { 
            height: 10px;
            background-color: transparent;
            border: none; margin: 0;
        }
        .settings-logout-item .settings-text,
        .settings-logout-item .settings-icon { color: #e74c3c; } 
        .settings-logout-item:hover { background-color: #fceded; }

        /* --- Edit Profile Modal Styles --- */
        .edit-profile-avatar-section {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .edit-profile-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--whatsapp-light-green);
            margin-bottom: 10px;
            cursor: pointer; 
        }
        .change-avatar-button {
            background-color: var(--whatsapp-teal-green);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .change-avatar-button:hover {
            background-color: var(--whatsapp-dark-green);
        }
        .avatar-note {
            font-size: 12px;
            color: var(--whatsapp-text-secondary);
            margin-top: 5px;
        }

        .input-group-modal {
            margin-bottom: 15px;
            text-align: right; 
            flex-shrink: 0;
        }
        .input-group-modal label {
            display: block;
            font-size: 14px;
            color: var(--whatsapp-text-secondary);
            margin-bottom: 5px;
        }
        .input-field-modal { 
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #F9F9F9;
            color: var(--whatsapp-text-primary);
            outline: none;
        }
        .input-field-modal:focus {
            border-color: var(--whatsapp-light-green);
            background-color: white;
            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.15);
        }
        .modal-buttons .save-profile-btn { 
            background-color: var(--whatsapp-light-green);
            color: white;
        }

        /* --- Create Group Modal Styles --- */
        .members-selection-container {
            max-height: 150px; 
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-top: 5px;
            text-align: right; 
            flex-grow: 1; 
            min-height: 50px; 
        }
        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        .member-selection-item input[type="checkbox"] {
            margin-left: 10px; 
            transform: scale(1.2); 
        }
        .member-selection-item label {
            font-size: 15px;
            color: var(--whatsapp-text-primary);
        }
        .action-button-tab { 
            background-color: var(--whatsapp-light-green);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 15px;
            border: none;
            cursor: pointer;
            display: block; 
            margin: 20px auto 0 auto; 
        }
        .action-button-tab:hover {
            background-color: var(--whatsapp-dark-green);
        }

        /* --- On Call Page Styles --- */
        .on-call-page-fullscreen {
            background-color: #222; 
            color: white;
            justify-content: space-between; 
            align-items: center;
            padding: 20px;
            z-index: 3000; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
        }
        .on-call-background { 
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(10px);
            opacity: 0.3;
            z-index: -1;
        }
        .on-call-header {
            text-align: center;
            margin-top: 40px; 
        }
        .on-call-contact-name {
            font-size: 24px;
            font-weight: 500;
            display: block;
        }
        .on-call-status, .on-call-timer {
            font-size: 16px;
            color: #ccc;
            display: block;
            margin-top: 5px;
        }
        .on-call-avatar-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .on-call-contact-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.5);
        }
        .on-call-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            padding: 20px 0;
            background-color: rgba(0,0,0,0.2); 
            border-radius: 15px; 
            margin-bottom: 30px;
        }
        .on-call-button {
            background-color: rgba(255,255,255,0.15);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px; 
            transition: background-color 0.2s;
        }
        .on-call-button:hover {
            background-color: rgba(255,255,255,0.3);
        }
        .on-call-button .icon {
            font-size: 24px; 
            margin-bottom: 2px;
        }
        .on-call-button.active { 
             background-color: rgba(255,255,255,0.3);
        }
        .end-call-button {
            background-color: #e74c3c; 
        }
        .end-call-button:hover {
            background-color: #c0392b;
        }
        /* New Modal Button Style */
        .modal-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            border: none;
            border-radius: 5px;
            background-color: var(--whatsapp-background-app);
            color: var(--whatsapp-text-primary);
            font-size: 16px;
            cursor: pointer;
            text-align: right;
        }
        .modal-button:hover {
            background-color: #e0e0e0;
        }

    </style>
</head>
<body>

    <div id="welcomePage" class="page active">
        <div class="welcome-inner">
            <div class="logo">TG</div>
            <h1>مرحباً بك في Talkgram</h1>
            <p class="tagline">انقر على "الموافقة والمتابعة" لقبول شروط خدمة Talkgram.</p>
            <button class="agree-button" onclick="showPage('registerPage')">الموافقة والمتابعة</button>
            <button class="agree-button secondary" style="background-color: var(--whatsapp-dark-green); color:white;" onclick="showPage('loginPage')">لدي حساب بالفعل؟</button>
            <a class="privacy-link" href="#" onclick="alert('سيتم عرض سياسة الخصوصية هنا')">شروط الخدمة وسياسة الخصوصية</a>
        </div>
    </div>

    <div id="registerPage" class="page">
         <div class="app-header" style="background-color: transparent;">
            <span style="width:48px;"></span>
            <span class="title" style="color: var(--whatsapp-dark-green);">إنشاء حساب</span>
            <span style="width:48px;"></span>
        </div>
        <div class="auth-content-container">
            <form id="registerForm" class="auth-form">
                <h2 style="color: var(--whatsapp-text-primary); font-weight:normal; font-size:17px;">أدخل معلوماتك لإنشاء حساب جديد.</h2>
                <div class="input-group">
                    <input type="text" id="username" name="username" class="input-field" placeholder="معرف المستخدم (يبدأ بـ @)" required>
                </div>
                <div class="input-group">
                    <input type="email" id="email" name="email" class="input-field" placeholder="البريد الإلكتروني" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" name="password" class="input-field" placeholder="كلمة المرور" required>
                </div>
                <div class="input-group">
                    <input type="password" id="confirmPassword" name="confirmPassword" class="input-field" placeholder="تأكيد كلمة المرور" required>
                </div>
                <button type="submit" class="auth-action-button">إنشاء حساب</button>
            </form>
            <a class="link-style" style="margin-top:30px;" onclick="showPage('loginPage')">لديك حساب بالفعل؟ تسجيل الدخول</a>
        </div>
    </div>

    <div id="loginPage" class="page">
        <div class="app-header" style="background-color: transparent;">
             <span style="width:48px;"></span>
            <span class="title" style="color: var(--whatsapp-dark-green);">تسجيل الدخول</span>
             <span style="width:48px;"></span>
        </div>
        <div class="auth-content-container">
            <form id="loginForm" class="auth-form">
                <h2 style="color: var(--whatsapp-text-primary); font-weight:normal; font-size:17px;">مرحباً بعودتك! الرجاء تسجيل الدخول.</h2>
                <div class="input-group">
                    <input type="text" id="loginIdentifier" name="loginIdentifier" class="input-field" placeholder="البريد الإلكتروني أو معرف المستخدم" required>
                </div>
                <div class="input-group">
                    <input type="password" id="passwordLogin" name="passwordLogin" class="input-field" placeholder="كلمة المرور" required>
                </div>
                <button type="submit" class="auth-action-button">تسجيل الدخول</button>
            </form>
            <div class="extra-links" style="margin-top:30px;">
                <a class="link-style" style="font-size:15px;" onclick="alert('سيتم توجيهك لصفحة استعادة كلمة المرور')">هل نسيت كلمة المرور؟</a>
                <br>
                <a class="link-style" style="font-size:15px; margin-top:15px;" onclick="showPage('registerPage')">إنشاء حساب جديد</a>
            </div>
        </div>
    </div>

    <div id="chatsPage" class="page">
        <div class="app-header">
            <span class="title">Talkgram</span>
            <div class="actions">
                <button title="كاميرا" onclick="handleHeaderCameraClick()">📸</button>
                <button title="بحث" id="toggleSearchButtonChats">🔍</button>
                <button title="قائمة" onclick="alert('قائمة...')">⋮</button>
            </div>
        </div>
        <div class="tabs">
            <div class="tab-item icon-only" onclick="switchTab(this, 'communitiesTabContent')"><span class="icon">👥</span></div>
            <div class="tab-item active" onclick="switchTab(this, 'chatsTabContent')">الدردشات</div>
            <div class="tab-item" onclick="switchTab(this, 'statusTabContent')">الحالة</div>
            <div class="tab-item" onclick="switchTab(this, 'callsTabContent')">المكالمات</div>
            <div class="tab-item" onclick="switchTab(this, 'settingsTabContent')">الإعدادات</div> 
        </div>

        <div class="chat-list-page-content"> 
            <div id="searchBarContainerChats" class="search-bar-container" style="display: none;">
                <div class="search-input-wrapper">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="chatSearchInput" placeholder="ابحث أو ابدأ دردشة جديدة...">
                </div>
            </div>

            <div id="chatsTabContent" class="tab-content active">
                <div class="chat-list-container"></div>
            </div>

            <div id="statusTabContent" class="tab-content">
                <div class="status-section"> 
                    <div id="myStatusContainer" class="status-item status-item-my" onclick="viewMyStatuses()">
                        <div class="status-avatar-wrapper">
                            <img id="myStatusAvatar" src="https://via.placeholder.com/48/075E54/FFFFFF?text=ME" alt="My Avatar" class="status-avatar">
                            <div id="myStatusRing" class="status-avatar-ring"></div>
                            <span id="myStatusAddIcon" class="status-add-icon" onclick="event.stopPropagation(); openCreateStatusModal();">+</span>
                        </div>
                        <div class="status-info">
                            <span class="status-name">حالتي</span>
                            <span id="myStatusTime" class="status-time">انقر لإضافة تحديث للحالة</span>
                        </div>
                    </div>
                </div>
                <div class="status-section">
                    <h4>التحديثات الأخيرة</h4>
                    <div id="recentUpdatesContainer"></div>
                </div>
                 <div class="status-section">
                    <h4>التحديثات المشاهدة</h4>
                    <div id="viewedUpdatesContainer"></div>
                </div>
            </div>

            <div id="callsTabContent" class="tab-content" style="padding:20px; text-align:center;">محتوى تبويب المكالمات هنا...</div>
            
            <div id="communitiesTabContent" class="tab-content" style="padding:20px; text-align:center;">
                محتوى تبويب المجموعات هنا...
                <button class="action-button-tab" onclick="openCreateGroupModal()">إنشاء مجموعة جديدة</button>
            </div>

            <div id="settingsTabContent" class="tab-content">
                <div class="settings-content"> 
                    <div class="settings-item" onclick="openEditProfileModal()">
                        <div class="settings-item-avatar-wrapper">
                            <img id="settingsUserAvatar" src="https://via.placeholder.com/60/075E54/FFFFFF?text=ME" alt="Avatar" class="settings-user-avatar">
                        </div>
                        <div class="settings-item-info">
                            <span id="settingsUserName" class="settings-user-name">اسمك هنا</span>
                            <span class="settings-user-status">وصف الحالة المتاح هنا...</span>
                        </div>
                         <span class="settings-item-action-icon" onclick="event.stopPropagation(); openEditProfileModal()">✏️</span>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-item" onclick="alert('إعدادات الحساب...')">
                        <span class="settings-icon">🔑</span>
                        <div class="settings-item-info" style="flex-direction: column; align-items: flex-start;">
                            <span class="settings-text">الحساب</span>
                            <span class="settings-subtext">الخصوصية، الأمان، تغيير الرقم</span>
                        </div>
                    </div>
                    <div class="settings-item" onclick="alert('إعدادات الدردشات...')">
                        <span class="settings-icon">💬</span>
                         <div class="settings-item-info" style="flex-direction: column; align-items: flex-start;">
                            <span class="settings-text">الدردشات</span>
                            <span class="settings-subtext">المظهر، الخلفية، سجل الدردشات</span>
                        </div>
                    </div>
                    <div class="settings-item" onclick="alert('إعدادات الإشعارات...')">
                        <span class="settings-icon">🔔</span>
                         <div class="settings-item-info" style="flex-direction: column; align-items: flex-start;">
                            <span class="settings-text">الإشعارات</span>
                            <span class="settings-subtext">نغمات الرسائل والمجموعات والمكالمات</span>
                        </div>
                    </div>
                    <div class="settings-item" onclick="alert('إعدادات التخزين والبيانات...')">
                        <span class="settings-icon">📊</span>
                        <div class="settings-item-info" style="flex-direction: column; align-items: flex-start;">
                            <span class="settings-text">التخزين والبيانات</span>
                            <span class="settings-subtext">استخدام الشبكة، التنزيل التلقائي</span>
                        </div>
                    </div>
                    <div class="settings-divider"></div>
                     <div class="settings-item" onclick="alert('صفحة المساعدة...')">
                        <span class="settings-icon">❓</span>
                         <div class="settings-item-info" style="flex-direction: column; align-items: flex-start;">
                            <span class="settings-text">المساعدة</span>
                            <span class="settings-subtext">مركز المساعدة، اتصل بنا، سياسة الخصوصية</span>
                         </div>
                    </div>
                     <div class="settings-item" onclick="alert('دعوة صديق...')">
                        <span class="settings-icon">➕</span>
                        <span class="settings-text">دعوة صديق</span>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-item settings-logout-item" onclick="logout()">
                        <span class="settings-icon">↪</span>
                        <span class="settings-text">تسجيل الخروج</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chatDetailPage" class="page">
        <div class="app-header">
            <button class="back-button" onclick="showPage('chatsPage')">←</button>
            <div class="header-content">
                <div class="header-avatar">
                    <img id="chatDetailAvatar" src="https://via.placeholder.com/40" alt="Avatar">
                </div>
                <div class="header-info">
                    <span class="title" id="chatDetailName">اسم المستخدم</span>
                    <span class="subtitle" id="chatDetailStatus">متصل الآن</span>
                </div>
            </div>
            <div class="actions">
                <button title="مكالمة فيديو" onclick="initiateCall('video')">📹</button>
                <button title="مكالمة صوتية" onclick="initiateCall('audio')">📞</button>
                <button title="قائمة" onclick="alert('قائمة المحادثة...')">⋮</button>
            </div>
        </div>
        <div class="messages-container" id="messagesList">
            <div class="system-message">🔒 الرسائل والمكالمات مشفرة تماماً بين الطرفين.</div>
        </div>
        <div class="chat-input-bar"> 
            <div class="actions-left"> 
                <button title="إيموجي" id="emojiButton" onclick="toggleEmojiPicker()">😊</button> 
            </div>
            <div class="chat-input-wrapper"> 
                <textarea id="chatMessageInput" placeholder="اكتب رسالة..." rows="1"></textarea> 
            </div>
            <div class="actions-right">
                <button title="إرفاق" id="attachFileButton" onclick="triggerImageUpload()">📎</button>
                <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
                <button title="كاميرا" onclick="alert('كاميرا')">📸</button>
            </div>
            <button class="send-button" id="sendMessageButton" title="إرسال">➢</button>
        </div>
        <div id="emojiPicker" class="emoji-picker" style="display: none;"> 
        </div>
    </div>

    <div id="onCallPage" class="page on-call-page-fullscreen">
        <div class="on-call-background"></div>
        <div class="on-call-header">
            <span id="onCallContactName" class="on-call-contact-name">اسم المتصل به</span>
            <span id="onCallStatus" class="on-call-status">جاري الاتصال...</span>
            <span id="onCallTimer" class="on-call-timer" style="display:none;">00:00</span>
        </div>
        <div class="on-call-avatar-container">
            <img id="onCallContactAvatar" src="https://via.placeholder.com/120" alt="Avatar" class="on-call-contact-avatar">
        </div>
        <div class="on-call-controls">
            <button id="toggleMuteButton" class="on-call-button" onclick="toggleMute()"><span class="icon">🎤</span><span class="label">كتم</span></button>
            <button id="toggleVideoButton" class="on-call-button" onclick="toggleVideo()" style="display:none;"><span class="icon">📸</span><span class="label">كاميرا</span></button>
            <button id="toggleSpeakerButton" class="on-call-button" onclick="toggleSpeaker()"><span class="icon">🔈</span><span class="label">مكبر</span></button>
            <button class="on-call-button end-call-button" onclick="endCall()"><span class="icon">📞</span><span class="label">إنهاء</span></button>
        </div>
    </div>


    <div id="createStatusModal" class="modal">
        <div class="modal-content">
            <h3>إنشاء حالة جديدة</h3>
            <textarea id="statusText" placeholder="اكتب حالتك... (اختياري للصورة)"></textarea>
            <div>
                <input type="file" id="statusImageFile" accept="image/*" style="display: none;">
                <button class="file-input-button" onclick="document.getElementById('statusImageFile').click()">📷 اختيار صورة</button>
            </div>
            <img id="statusImagePreview" src="#" alt="معاينة الصورة" style="display:none;" class="image-preview"/>
            <div class="modal-buttons">
                <button onclick="closeModal('createStatusModal')">إلغاء</button>
                <button class="post-status-btn" onclick="postNewStatus()">نشر الحالة</button>
            </div>
        </div>
    </div>

    <div id="statusViewerModal" class="modal">
        <div class="status-viewer-content">
            <div class="status-progress-bars" id="statusViewerProgressBars"></div>
            <div class="status-viewer-header">
                <img id="statusViewerAvatar" src="" alt="Avatar">
                <div class="name-time">
                    <span id="statusViewerName" class="name"></span>
                    <span id="statusViewerTime" class="time"></span>
                </div>
            </div>
            <button class="status-viewer-close" onclick="closeModal('statusViewerModal')">×</button>
            <img id="statusViewerImage" src="" alt="Status Image" class="status-viewer-media" style="display:none;">
            <div id="statusViewerText" class="status-viewer-text" style="display:none;"></div>
            <div id="statusViewerCaption" class="status-viewer-caption" style="display:none;"></div>
            <div class="status-nav prev" onclick="navigateStatus(-1, true)"></div>
            <div class="status-nav next" onclick="navigateStatus(1, true)"></div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <h3>تعديل الملف الشخصي</h3>
            <div class="edit-profile-avatar-section">
                <img id="editProfileAvatarPreview" src="https://via.placeholder.com/100/075E54/FFFFFF?text=ME" alt="Profile Avatar" class="edit-profile-avatar-preview">
                <input type="file" id="editProfileAvatarFile" accept="image/*" style="display: none;">
                <button class="change-avatar-button" onclick="document.getElementById('editProfileAvatarFile').click()">تغيير الصورة</button>
                <p class="avatar-note">(محاكاة: سيتم تحديث الرابط فقط أو استخدام صورة من placeholder)</p>
            </div>
            <div class="input-group-modal">
                <label for="editProfileNameInput">الاسم:</label>
                <input type="text" id="editProfileNameInput" class="input-field-modal" placeholder="أدخل اسمك">
            </div>
            <div class="input-group-modal">
                <label for="editProfileStatusTextInput">الحالة (About):</label>
                <textarea id="editProfileStatusTextInput" class="input-field-modal" placeholder="اكتب شيئًا عن نفسك..." rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('editProfileModal')">إلغاء</button>
                <button class="save-profile-btn" onclick="saveProfileChanges()">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <h3>إنشاء مجموعة جديدة</h3>
            <div class="input-group-modal">
                <label for="groupNameInput">اسم المجموعة:</label>
                <input type="text" id="groupNameInput" class="input-field-modal" placeholder="اكتب اسم المجموعة..." required>
            </div>
            <div class="input-group-modal">
                <label for="groupDescriptionInput">وصف المجموعة (اختياري):</label>
                <textarea id="groupDescriptionInput" class="input-field-modal" placeholder="اكتب وصفًا للمجموعة..." rows="2"></textarea>
            </div>
            <div class="input-group-modal">
                <label>إضافة أعضاء:</label>
                <div id="groupMembersSelection" class="members-selection-container">
                    <p>لا توجد جهات اتصال متاحة للإضافة.</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeModal('createGroupModal')">إلغاء</button>
                <button class="create-group-btn" onclick="createNewGroup()">إنشاء المجموعة</button>
            </div>
        </div>
    </div>

    <div id="messageOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 300px; padding: 15px;">
            <button class="modal-button" onclick="replyToMessage()">الرد</button>
            <button class="modal-button" onclick="copyMessageText()">نسخ</button>
            <button class="modal-button" onclick="deleteMessage()">حذف</button>
            <button class="modal-button" onclick="closeModal('messageOptionsModal')" style="background-color: #f0f0f0; color: var(--whatsapp-text-primary); margin-top: 10px;">إلغاء</button>
        </div>
    </div>


    <script>
        const sampleChats = [
            { id: 1, name: "صديق ١", username: "@friend_one", avatar: "https://via.placeholder.com/48/075E54/FFFFFF?text=S1", lastMessage: "مرحباً! كيف حالك اليوم؟", time: "10:30 ص", unread: 2, onlineStatus: "متصل الآن", isGroup: false },
            { id: 2, name: "مجموعة العمل", avatar: "https://via.placeholder.com/48/25D366/FFFFFF?text=WG", lastMessage: "أحمد: لا تنسوا اجتماع الغد.", time: "أمس", unread: 0, onlineStatus: "5 أعضاء متصلون", isGroup: true, members: ["أنت", "أحمد", "مدير المشروع", "سالم", "فاطمة"] },
            { id: 3, name: "سارة", username: "@sarah_K", avatar: "https://via.placeholder.com/48/128C7E/FFFFFF?text=S", lastMessage: "تمام، سأكون هناك.", time: "الاثنين", unread: 0, onlineStatus: "آخر ظهور اليوم عند 09:15 ص", isGroup: false },
            { id: 4, name: "@user_alpha", username: "@user_alpha", avatar: "https://via.placeholder.com/48/FFC107/000000?text=UA", lastMessage: "هل أنت متاح للاجتماع؟", time: "11:45 ص", unread: 1, onlineStatus: "يكتب...", isGroup: false },
            { id: 5, name: "خدمة العملاء", avatar: "https://via.placeholder.com/48/007BFF/FFFFFF?text=CS", lastMessage: "شكراً لتواصلك معنا.", time: "08:00 ص", unread: 0, onlineStatus: "متصل", isGroup: false }
        ];
        let sampleGroups = []; 

        let messageInputArea, sendMessageBtn, chatMessagesListContainer;
        let toggleSearchBtnChats, searchBarContainerChats, chatSearchInputEl;
        
        let statusTextEl, statusImageFileEl, statusImagePreviewEl;
        let myStatusContainerEl, myStatusAvatarEl, myStatusTimeEl, myStatusRingEl, myStatusAddIconEl;
        let recentUpdatesContainerEl, viewedUpdatesContainerEl;

        let editProfileAvatarPreviewEl, editProfileAvatarFileEl, editProfileNameInputEl, editProfileStatusTextInputEl;

        let emojiPickerEl, emojiButtonEl;
        const commonEmojis = [ 
            '😀', '😂', '😊', '😍', '🤔', '😢', '😠', '👍', '👎', '❤️', '🎉', '🔥', '⭐', '🙏', '💪', '👀', '👋', '💯',
            '🙂', '🤩', '🥳', '😭', '😱', '🙄', '😇', '😷', '😴', '😅', '🤣', '😋', '😜', '🤫', '😬', '😒',
            '🥺', '👉', '👈', '👆', '👇', '👌', '✌️', '🤞', '🤟', '🤘', '🙌', '👏', '🤝', '💔', '💩', '👻', '💀',
            '☀️', '🌙', '🌍', '🌹', '🍉', '🍕', '🍔', '⚽', '🏀', '🎁', '💡', '💰', '💻', '📱', '⏰', '⏳'
        ];

        let attachFileButtonEl, imageUploadInputEl;
        let groupNameInputEl, groupDescriptionInputEl, groupMembersSelectionEl;

        let onCallPageEl, onCallContactNameEl, onCallStatusEl, onCallTimerEl, onCallContactAvatarEl;
        let toggleVideoButtonEl, toggleMuteButtonEl, toggleSpeakerButtonEl;
        let callTimerInterval = null;
        let callDurationSeconds = 0;
        let currentCallType = null; 
        let isMuted = false;
        let isSpeakerOn = false;
        let isVideoOn = true; 


        let myStatuses = []; 
        let contactStatuses = {};
        const STATUS_DURATION = 24 * 60 * 60 * 1000;
        const STATUS_VIEW_TIME = 5000;

        let currentStatusViewer = { statuses: [], currentIndex: 0, timeoutId: null, contactName: '', contactAvatar: '' };
        
        let myUserInfo = {
            name: "اسمك الافتراضي", 
            avatar: "https://via.placeholder.com/100/075E54/FFFFFF?text=??", 
            statusText: "متاح" 
        };
        
        let selectedMessageElement = null; // New global variable for message options

        document.addEventListener('DOMContentLoaded', () => {
            messageInputArea = document.getElementById('chatMessageInput');
            sendMessageBtn = document.getElementById('sendMessageButton');
            chatMessagesListContainer = document.getElementById('messagesList');
            toggleSearchBtnChats = document.getElementById('toggleSearchButtonChats');
            searchBarContainerChats = document.getElementById('searchBarContainerChats');
            chatSearchInputEl = document.getElementById('chatSearchInput');

            statusTextEl = document.getElementById('statusText');
            statusImageFileEl = document.getElementById('statusImageFile');
            statusImagePreviewEl = document.getElementById('statusImagePreview');
            myStatusContainerEl = document.getElementById('myStatusContainer');
            myStatusAvatarEl = document.getElementById('myStatusAvatar');
            myStatusTimeEl = document.getElementById('myStatusTime');
            myStatusRingEl = document.getElementById('myStatusRing');
            myStatusAddIconEl = document.getElementById('myStatusAddIcon');
            recentUpdatesContainerEl = document.getElementById('recentUpdatesContainer');
            viewedUpdatesContainerEl = document.getElementById('viewedUpdatesContainer');

            editProfileAvatarPreviewEl = document.getElementById('editProfileAvatarPreview');
            editProfileAvatarFileEl = document.getElementById('editProfileAvatarFile');
            editProfileNameInputEl = document.getElementById('editProfileNameInput');
            editProfileStatusTextInputEl = document.getElementById('editProfileStatusTextInput');

            emojiPickerEl = document.getElementById('emojiPicker');
            emojiButtonEl = document.getElementById('emojiButton');

            attachFileButtonEl = document.getElementById('attachFileButton');
            imageUploadInputEl = document.getElementById('imageUploadInput');

            groupNameInputEl = document.getElementById('groupNameInput');
            groupDescriptionInputEl = document.getElementById('groupDescriptionInput');
            groupMembersSelectionEl = document.getElementById('groupMembersSelection');

            onCallPageEl = document.getElementById('onCallPage');
            onCallContactNameEl = document.getElementById('onCallContactName');
            onCallStatusEl = document.getElementById('onCallStatus');
            onCallTimerEl = document.getElementById('onCallTimer');
            onCallContactAvatarEl = document.getElementById('onCallContactAvatar');
            toggleVideoButtonEl = document.getElementById('toggleVideoButton');
            toggleMuteButtonEl = document.getElementById('toggleMuteButton');
            toggleSpeakerButtonEl = document.getElementById('toggleSpeakerButton');


            showPage('welcomePage');
            renderChatList(sampleChats);
            loadStatusesFromLocalStorage();
            initializeMyUserInfo(); 
            renderStatusTab();     
            if (emojiPickerEl) renderEmojiPicker();


            if (toggleSearchBtnChats && searchBarContainerChats) {
                toggleSearchBtnChats.addEventListener('click', () => {
                    const isHidden = searchBarContainerChats.style.display === 'none' || searchBarContainerChats.style.display === '';
                    searchBarContainerChats.style.display = isHidden ? 'flex' : 'none';
                    if (isHidden) chatSearchInputEl.focus();
                    else { chatSearchInputEl.value = ''; renderChatList(sampleChats); }
                });
            }
            if (chatSearchInputEl) {
                chatSearchInputEl.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    const filteredChats = sampleChats.filter(chat =>
                        chat.name.toLowerCase().includes(searchTerm) ||
                        (chat.username && chat.username.toLowerCase().includes(searchTerm))
                    );
                    renderChatList(filteredChats);
                });
            }
            if(messageInputArea) messageInputArea.addEventListener('input', autoResizeTextarea);
            if(sendMessageBtn && messageInputArea){
                sendMessageBtn.addEventListener('click', handleSendMessage);
                messageInputArea.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }
                });
            }
            if (statusImageFileEl) { 
                statusImageFileEl.addEventListener('change', previewStatusImage);
            }
            if (myStatusAddIconEl) {
                myStatusAddIconEl.addEventListener('click', (event) => {
                    event.stopPropagation(); openCreateStatusModal();
                });
            }
            if (editProfileAvatarFileEl) {
                editProfileAvatarFileEl.addEventListener('change', previewEditProfileAvatar);
            }
            if (imageUploadInputEl) { 
                imageUploadInputEl.addEventListener('change', handleImageUpload);
            }
            initializeAuthForms();
        });
        
        function initializeMyUserInfo() {
            if (myStatusAvatarEl) myStatusAvatarEl.src = myUserInfo.avatar; 
            updateSettingsUserInfo(); 
        }

        function updateSettingsUserInfo() {
            const settingsUserAvatarEl = document.querySelector('#settingsTabContent #settingsUserAvatar');
            const settingsUserNameEl = document.querySelector('#settingsTabContent #settingsUserName');
            const settingsUserStatusEl = document.querySelector('#settingsTabContent .settings-user-status');

            if (settingsUserAvatarEl) settingsUserAvatarEl.src = myUserInfo.avatar;
            if (settingsUserNameEl) settingsUserNameEl.textContent = myUserInfo.name;
            if (settingsUserStatusEl) settingsUserStatusEl.textContent = myUserInfo.statusText;
        }


        function autoResizeTextarea() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; }

        function handleSendMessage(){
            const messageText = messageInputArea.value.trim();
            if(messageText){
                addMessageToChat(messageText, true); 
                messageInputArea.value = '';
                autoResizeTextarea.call(messageInputArea); 
                if (emojiPickerEl && emojiPickerEl.style.display !== 'none') { 
                    toggleEmojiPicker();
                }
                setTimeout(() => {
                    const chatPartnerName = document.getElementById('chatDetailName').textContent;
                    addMessageToChat("تم استلام نصك: " + messageText + " (رد تلقائي من " + chatPartnerName + ")", false);
                }, 1000 + Math.random() * 1000);
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.add('active');

            if (pageId === 'chatsPage') {
                const currentActiveTabItem = document.querySelector('#chatsPage .tab-item.active');
                let targetTabContentId = 'chatsTabContent'; 
                if (currentActiveTabItem) {
                    const onclickAttr = currentActiveTabItem.getAttribute('onclick');
                    const match = onclickAttr ? onclickAttr.match(/'([^']+)'/) : null;
                    if (match && match[1]) targetTabContentId = match[1];
                } else { 
                     const chatsTabButton = document.querySelector('.tab-item[onclick*="chatsTabContent"]');
                     if (chatsTabButton) targetTabContentId = 'chatsTabContent'; 
                }
                const targetTabButton = document.querySelector(`.tab-item[onclick*="'${targetTabContentId}'"]`);
                if (targetTabButton) switchTab(targetTabButton, targetTabContentId);
            }
            
            if (pageId === 'welcomePage' || pageId === 'registerPage' || pageId === 'loginPage') {
                document.body.style.overflow = 'auto';
            } else { 
                document.body.style.overflow = 'hidden';
            }
            
            if (pageId !== 'chatDetailPage' && pageId !== 'onCallPage' && emojiPickerEl && emojiPickerEl.style.display !== 'none') {
                toggleEmojiPicker(); 
            }
        }

        function switchTab(tabElement, tabContentId) {
            const page = tabElement.closest('.page');
            if (!page) return;
            page.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            page.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            
            const activeTabContent = document.getElementById(tabContentId);
            if(activeTabContent) {
                activeTabContent.style.display = 'block';
                if (tabContentId === 'statusTabContent') {
                    renderStatusTab();
                } else if (tabContentId === 'settingsTabContent') { 
                    updateSettingsUserInfo(); 
                }
            }
            tabElement.classList.add('active');
        }

        function renderChatList(chatsToRender) {
            const container = document.querySelector('#chatsPage #chatsTabContent .chat-list-container');
            if (!container) return;
            container.innerHTML = '';
            if (chatsToRender.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color: var(--whatsapp-text-secondary);">لا توجد دردشات.</p>';
                return;
            }
            chatsToRender.sort((a, b) => { 
                if (a.isGroup && !b.isGroup) return -1;
                if (!a.isGroup && b.isGroup) return 1;
                return 0; 
            });

            chatsToRender.forEach(chat => {
                container.insertAdjacentHTML('beforeend', `
                    <div class="chat-item" onclick="openChatDetail('${escapeHTML(chat.name)}', '${escapeHTML(chat.avatar)}', '${escapeHTML(chat.onlineStatus)}')">
                        <div class="avatar"><img src="${escapeHTML(chat.avatar)}" alt="${escapeHTML(chat.name.substring(0,1))}"></div>
                        <div class="chat-content">
                            <div class="chat-name-time">
                                <span class="chat-name">${escapeHTML(chat.name)}</span>
                                <span class="chat-time">${escapeHTML(chat.time)}</span>
                            </div>
                            <div class="last-message-line">
                                <span class="last-message">${escapeHTML(chat.lastMessage)}</span>
                                ${chat.unread > 0 ? `<span class="unread-badge">${chat.unread}</span>` : ''}
                            </div>
                        </div>
                    </div>`);
            });
        }
        
        function startNewChat() {
            const searchBar = document.getElementById('searchBarContainerChats');
            const searchInput = document.getElementById('chatSearchInput');
            const chatsTabButton = document.querySelector('.tab-item[onclick*="chatsTabContent"]');
            if (chatsTabButton && !chatsTabButton.classList.contains('active')) switchTab(chatsTabButton, 'chatsTabContent');
            if (searchBar.style.display === 'none' || searchBar.style.display === '') searchBar.style.display = 'flex';
            searchInput.value = '';
            renderChatList(sampleChats);
            searchInput.focus();
        }

        function openChatDetail(chatName, avatarUrl, onlineStatus) {
            document.getElementById('chatDetailName').textContent = chatName;
            document.getElementById('chatDetailAvatar').src = avatarUrl;
            document.getElementById('chatDetailStatus').textContent = onlineStatus;
            if (chatMessagesListContainer) {
                chatMessagesListContainer.innerHTML = `
                    <div class="system-message">🔒 الرسائل والمكالمات مشفرة تماماً بين الطرفين.</div>
                    <div class="message-bubble incoming" data-message-id="mock-1" data-message-text="مرحباً! أنا ${escapeHTML(chatName)}. كيف يمكنني مساعدتك؟" data-is-outgoing="false" onclick="openMessageOptions(this)">
                        <div class="text">مرحباً! أنا ${escapeHTML(chatName)}. كيف يمكنني مساعدتك؟</div>
                        <div class="meta">الآن</div>
                    </div>`;
            }
            showPage('chatDetailPage');
            scrollToBottomMessages();
            if(messageInputArea) messageInputArea.focus();
        }

        function addMessageToChat(messageData, isOutgoing) {
            if (!chatMessagesListContainer) return;
            const bubbleClass = isOutgoing ? 'outgoing' : 'incoming';
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
            const readTicksHTML = isOutgoing ? `<span class="read-ticks sent">✓</span>` : '';
            let messageContentHTML = '';
            let additionalBubbleClass = '';
            const messageId = Date.now() + '-' + Math.random().toString(36).substring(2, 9); // توليد معرّف فريد

            let messageTextForCopy = ''; // لتخزين النص للنسخ

            if (typeof messageData === 'string') {
                messageContentHTML = `<div class="text">${escapeHTML(messageData)}</div>`;
                messageTextForCopy = messageData;
            } else if (messageData.type === 'image') {
                additionalBubbleClass = 'has-image';
                messageContentHTML = `<img src="${escapeHTML(messageData.content)}" alt="رسالة صورة" class="message-image" onclick="viewFullImage('${escapeHTML(messageData.content)}')">`;
                if (messageData.text) {
                    messageContentHTML += `<div class="text caption-for-image">${escapeHTML(messageData.text)}</div>`;
                    messageTextForCopy = messageData.text; // إذا كانت هناك تسمية توضيحية للصورة
                }
                messageTextForCopy = messageData.text || ''; // إذا لم تكن هناك تسمية توضيحية، النص فارغ
            }

            // إضافة بيانات الرسالة كـ data attributes
            const messageBubbleHtml = `
                <div class="message-bubble ${bubbleClass} ${additionalBubbleClass}"
                     data-message-id="${messageId}"
                     data-message-text="${escapeHTML(messageTextForCopy)}"
                     data-is-outgoing="${isOutgoing}"
                     onclick="openMessageOptions(this)">
                    ${messageContentHTML}
                    <div class="meta">${timeString}${readTicksHTML}</div>
                </div>`;

            chatMessagesListContainer.insertAdjacentHTML('beforeend', messageBubbleHtml);
            scrollToBottomMessages();
        }

        function viewFullImage(imageUrl) {
            const viewerModal = document.getElementById('statusViewerModal'); 
            if (viewerModal) {
                const imgElement = viewerModal.querySelector('#statusViewerImage'); 
                const textElement = viewerModal.querySelector('#statusViewerText');
                const captionElement = viewerModal.querySelector('#statusViewerCaption');
                const headerInfo = viewerModal.querySelector('.status-viewer-header');
                const progressBars = viewerModal.querySelector('.status-progress-bars');

                if (imgElement && textElement && headerInfo && progressBars && captionElement) {
                    imgElement.src = imageUrl;
                    imgElement.style.display = 'block';
                    textElement.style.display = 'none'; 
                    captionElement.style.display = 'none'; 
                    headerInfo.style.display = 'none'; 
                    progressBars.style.display = 'none'; 
                    
                    const closeButton = viewerModal.querySelector('.status-viewer-close');
                    if (closeButton) {
                        closeButton.onclick = () => {
                            closeModal('statusViewerModal');
                            headerInfo.style.display = 'flex';
                            progressBars.style.display = 'flex';
                        };
                    }
                    openModal('statusViewerModal');
                } else {
                    alert("عارض الصور غير مهيأ بشكل صحيح.");
                }
            }
        }

        
        function scrollToBottomMessages() { if (chatMessagesListContainer) chatMessagesListContainer.scrollTop = chatMessagesListContainer.scrollHeight; }
        function escapeHTML(str) { if (typeof str !== 'string') return ''; const p = document.createElement("p"); p.textContent = str; return p.innerHTML; }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
            const anyModalActive = document.querySelector('.modal.active');
            if (!anyModalActive) {
                const currentPageActive = document.querySelector('.page.active');
                if (currentPageActive && (currentPageActive.id === 'welcomePage' || currentPageActive.id === 'registerPage' || currentPageActive.id === 'loginPage')) {
                    document.body.style.overflow = 'auto';
                } else { 
                    document.body.style.overflow = 'hidden';
                }
            }
            if (modalId === 'statusViewerModal' && currentStatusViewer.timeoutId) { clearTimeout(currentStatusViewer.timeoutId); currentStatusViewer.timeoutId = null; }
            if (modalId === 'createStatusModal') { statusTextEl.value = ''; statusImageFileEl.value = null; statusImagePreviewEl.src = '#'; statusImagePreviewEl.style.display = 'none'; }
            if (modalId === 'editProfileModal' && editProfileAvatarFileEl) { editProfileAvatarFileEl.value = null; }
            if (modalId === 'createGroupModal') { 
                 if(groupNameInputEl) groupNameInputEl.value = '';
                 if(groupDescriptionInputEl) groupDescriptionInputEl.value = '';
                 if(groupMembersSelectionEl) groupMembersSelectionEl.innerHTML = '<p>لا توجد جهات اتصال متاحة للإضافة.</p>'; 
            }
        }

        function openCreateStatusModal(type = 'text') {
            closeModal('createStatusModal');
            statusTextEl.value = ''; statusImageFileEl.value = '';
            statusImagePreviewEl.style.display = 'none'; statusImagePreviewEl.src = '';
            openModal('createStatusModal');
            if (type === 'text') statusTextEl.focus();
        }

        function previewStatusImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { statusImagePreviewEl.src = e.target.result; statusImagePreviewEl.style.display = 'block'; }
                reader.readAsDataURL(file);
            } else { statusImagePreviewEl.style.display = 'none'; statusImagePreviewEl.src = ''; }
        }

        function postNewStatus() {
            const textContent = statusTextEl.value.trim();
            const imageFile = statusImageFileEl.files[0];
            if (!textContent && !imageFile) { alert("لا يمكنك نشر حالة فارغة!"); return; }
            const timestamp = new Date().toISOString();
            const id = Date.now().toString() + Math.random().toString(36).substring(2,7);
            let newStatusItem;
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    newStatusItem = { id, type: 'image', content: e.target.result, caption: textContent, timestamp, viewedByMeOnce: false };
                    myStatuses.push(newStatusItem);
                    myStatuses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    saveStatusesToLocalStorage(); renderStatusTab(); closeModal('createStatusModal'); alert("تم نشر الحالة المصورة بنجاح!");
                }
                reader.readAsDataURL(imageFile);
            } else if (textContent) {
                newStatusItem = { id, type: 'text', content: textContent, caption: '', timestamp, viewedByMeOnce: false };
                myStatuses.push(newStatusItem);
                myStatuses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                saveStatusesToLocalStorage(); renderStatusTab(); closeModal('createStatusModal'); alert("تم نشر الحالة النصية بنجاح!");
            }
        }
        
        function renderStatusTab() {
            const now = new Date();
            myStatuses = myStatuses.filter(status => (now - new Date(status.timestamp)) < STATUS_DURATION);
            if (myStatusTimeEl && myStatusRingEl && myStatusAddIconEl) {
                if (myStatuses.length > 0) {
                    const latestMyStatus = myStatuses[0];
                    myStatusTimeEl.textContent = `آخر تحديث: ${formatStatusTime(latestMyStatus.timestamp)}`;
                    myStatusRingEl.classList.add('has-status');
                    const allMyStatusesViewedOnce = myStatuses.every(s => s.viewedByMeOnce);
                    myStatusRingEl.classList.toggle('all-viewed', allMyStatusesViewedOnce); 
                    myStatusAddIconEl.style.display = 'flex';
                } else {
                    myStatusTimeEl.textContent = "انقر لإضافة تحديث للحالة";
                    myStatusRingEl.classList.remove('has-status', 'all-viewed');
                    myStatusAddIconEl.style.display = 'flex';
                }
            }

            if (!recentUpdatesContainerEl || !viewedUpdatesContainerEl) return;
            recentUpdatesContainerEl.innerHTML = ''; viewedUpdatesContainerEl.innerHTML = '';
            let hasRecentUnviewed = false; let hasViewedUpdates = false;

            sampleChats.forEach(chat => { if (!contactStatuses[chat.name] && chat.name !== myUserInfo.name && !chat.isGroup) contactStatuses[chat.name] = []; });
            if (Object.keys(contactStatuses).every(name => contactStatuses[name].length === 0)) {
                 if (sampleChats[0] && sampleChats[0].name !== myUserInfo.name && !sampleChats[0].isGroup) {
                    contactStatuses[sampleChats[0].name] = [
                        { id: 'cs1a'+Date.now(), type: 'text', content: 'يوم رائع! ☀️', caption:'', timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), avatar: sampleChats[0].avatar, viewed: false },
                        { id: 'cs1b'+Date.now(), type: 'image', content: 'https://picsum.photos/seed/status1/400/600', caption: 'من رحلتي', timestamp: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(), avatar: sampleChats[0].avatar, viewed: false }]; }
                 if (sampleChats[2] && sampleChats[2].name !== myUserInfo.name && !sampleChats[2].isGroup) {
                     contactStatuses[sampleChats[2].name] = [ { id: 'cs2a'+Date.now(), type: 'text', content: 'أستمتع بكتاب جديد.', caption: '', timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(), avatar: sampleChats[2].avatar, viewed: false }]; }
            }

            Object.keys(contactStatuses).forEach(contactName => {
                contactStatuses[contactName] = contactStatuses[contactName].filter(s => (now - new Date(s.timestamp)) < STATUS_DURATION);
                if (contactStatuses[contactName].length > 0) {
                    const statuses = contactStatuses[contactName];
                    statuses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latestStatus = statuses[0];
                    const allThisContactStatusesViewed = statuses.every(s => s.viewed);
                    const contactAvatar = latestStatus.avatar || "https://via.placeholder.com/48/CCCCCC/FFFFFF?text=" + escapeHTML(contactName.substring(0,1));
                    const statusItemHTML = `
                        <div class="status-item" onclick="viewContactStatus('${escapeHTML(contactName)}')">
                            <div class="status-avatar-wrapper">
                                <img src="${escapeHTML(contactAvatar)}" alt="${escapeHTML(contactName)}" class="status-avatar">
                                <div class="status-avatar-ring ${allThisContactStatusesViewed ? 'viewed' : ''}"></div>
                            </div>
                            <div class="status-info">
                                <span class="status-name">${escapeHTML(contactName)}</span>
                                <span class="status-time">${formatStatusTime(latestStatus.timestamp)} (${statuses.length})</span>
                            </div></div>`;
                    if (allThisContactStatusesViewed) { viewedUpdatesContainerEl.insertAdjacentHTML('beforeend', statusItemHTML); hasViewedUpdates = true; }
                    else { recentUpdatesContainerEl.insertAdjacentHTML('beforeend', statusItemHTML); hasRecentUnviewed = true; }
                }
            });
            if (!hasRecentUnviewed) recentUpdatesContainerEl.innerHTML = '<p style="text-align:center; padding:10px 0; color: var(--whatsapp-text-secondary);">لا توجد تحديثات جديدة.</p>';
            if (!hasViewedUpdates) viewedUpdatesContainerEl.innerHTML = '<p style="text-align:center; padding:10px 0; color: var(--whatsapp-text-secondary);">لا توجد تحديثات مشاهدة بعد.</p>';
            saveStatusesToLocalStorage();
        }

        function formatStatusTime(isoTimestamp) {
            const date = new Date(isoTimestamp); const now = new Date();
            const diffMs = now - date; const diffHours = Math.floor(diffMs / 3600000);
            const diffMins = Math.floor((diffMs % 3600000) / 60000);
            if (diffHours === 0 && diffMins < 1) return "الآن";
            if (diffHours === 0) return `منذ ${diffMins} دقيقة`;
            if (diffHours < 24) return `منذ ${diffHours} س، ${diffMins} د`;
            return date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' }) + " " + date.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function viewMyStatuses() {
            if (myStatuses.length === 0) { openCreateStatusModal(); return; }
            currentStatusViewer.statuses = [...myStatuses].reverse(); 
            currentStatusViewer.currentIndex = 0;
            currentStatusViewer.contactName = myUserInfo.name;
            currentStatusViewer.contactAvatar = myUserInfo.avatar;
            displayCurrentStatusInViewer(); openModal('statusViewerModal');
        }

        function viewContactStatus(contactName) {
            const statuses = contactStatuses[contactName];
            if (!statuses || statuses.length === 0) return;
            currentStatusViewer.statuses = [...statuses].reverse(); 
            currentStatusViewer.currentIndex = 0;
            currentStatusViewer.contactName = contactName;
            currentStatusViewer.contactAvatar = statuses[0].avatar || "https://via.placeholder.com/48/CCCCCC/FFFFFF?text=" + escapeHTML(contactName.substring(0,1));
            displayCurrentStatusInViewer(); openModal('statusViewerModal');
        }

        function displayCurrentStatusInViewer() {
            if (currentStatusViewer.timeoutId) clearTimeout(currentStatusViewer.timeoutId);
            const avatarEl = document.getElementById('statusViewerAvatar');
            const nameEl = document.getElementById('statusViewerName');
            const timeEl = document.getElementById('statusViewerTime');
            const imageMediaEl = document.getElementById('statusViewerImage');
            const textMediaEl = document.getElementById('statusViewerText');
            const captionEl = document.getElementById('statusViewerCaption');
            const progressBarsContainer = document.getElementById('statusViewerProgressBars');

            avatarEl.src = currentStatusViewer.contactAvatar; nameEl.textContent = currentStatusViewer.contactName;
            progressBarsContainer.innerHTML = '';
            currentStatusViewer.statuses.forEach((s, index) => {
                const barDiv = document.createElement('div'); barDiv.classList.add('status-progress-bar');
                const progressDiv = document.createElement('div'); progressDiv.classList.add('progress');
                if (index < currentStatusViewer.currentIndex) progressDiv.style.width = '100%';
                barDiv.appendChild(progressDiv); progressBarsContainer.appendChild(barDiv);
            });
            
            const statusItem = currentStatusViewer.statuses[currentStatusViewer.currentIndex];
            if (!statusItem) { closeModal('statusViewerModal'); renderStatusTab(); return; }
            timeEl.textContent = formatStatusTime(statusItem.timestamp);
            imageMediaEl.style.display = 'none'; textMediaEl.style.display = 'none';
            captionEl.style.display = 'none'; captionEl.textContent = '';

            if (statusItem.type === 'image') {
                imageMediaEl.src = statusItem.content; imageMediaEl.style.display = 'block';
                if (statusItem.caption) { captionEl.textContent = statusItem.caption; captionEl.style.display = 'block'; }
            } else if (statusItem.type === 'text') {
                textMediaEl.innerHTML = escapeHTML(statusItem.content).replace(/\n/g, '<br>');
                textMediaEl.style.display = 'flex';
            }

            if (currentStatusViewer.contactName === myUserInfo.name) {
                if (!statusItem.viewedByMeOnce) { statusItem.viewedByMeOnce = true; 
                    const originalStatus = myStatuses.find(s => s.id === statusItem.id);
                    if (originalStatus) originalStatus.viewedByMeOnce = true; }
            } else {
                if (!statusItem.viewed) { statusItem.viewed = true;
                    const contactOriginalStatuses = contactStatuses[currentStatusViewer.contactName];
                    if(contactOriginalStatuses){ const originalStatus = contactOriginalStatuses.find(s => s.id === statusItem.id);
                        if(originalStatus) originalStatus.viewed = true; } } }
            saveStatusesToLocalStorage();
            
            const currentProgressBarFill = progressBarsContainer.children[currentStatusViewer.currentIndex]?.querySelector('.progress');
            if(currentProgressBarFill) {
                currentProgressBarFill.style.transition = 'none'; currentProgressBarFill.style.width = '0%';
                void currentProgressBarFill.offsetWidth;
                currentProgressBarFill.style.transition = `width ${STATUS_VIEW_TIME / 1000}s linear`;
                currentProgressBarFill.style.width = '100%';
            }
            currentStatusViewer.timeoutId = setTimeout(() => { navigateStatus(1, false); }, STATUS_VIEW_TIME);
        }

        function navigateStatus(direction, userInitiated = false) {
            if (userInitiated && currentStatusViewer.timeoutId) clearTimeout(currentStatusViewer.timeoutId);
            currentStatusViewer.currentIndex += direction;
            if (currentStatusViewer.currentIndex >= currentStatusViewer.statuses.length || currentStatusViewer.currentIndex < 0) {
                closeModal('statusViewerModal'); renderStatusTab(); return;
            }
            displayCurrentStatusInViewer();
        }

        function saveStatusesToLocalStorage() {
            localStorage.setItem('myTalkgramStatuses', JSON.stringify(myStatuses));
            localStorage.setItem('contactTalkgramStatuses', JSON.stringify(contactStatuses));
        }
        function loadStatusesFromLocalStorage() {
            const storedMyStatuses = localStorage.getItem('myTalkgramStatuses');
            if (storedMyStatuses) { try { myStatuses = JSON.parse(storedMyStatuses); } catch (e) { myStatuses = []; } }
            const storedContactStatuses = localStorage.getItem('contactTalkgramStatuses');
            if (storedContactStatuses) { try { contactStatuses = JSON.parse(storedContactStatuses); } catch (e) { contactStatuses = {}; } }
        }

        function initializeAuthForms() {
            const registerFormEl = document.getElementById('registerForm');
            const usernameInputEl = document.getElementById('username');
            if (usernameInputEl) {
                usernameInputEl.addEventListener('blur', function() {
                    if (this.value && !this.value.startsWith('@')) this.value = '@' + this.value.replace(/[^a-zA-Z0-9_]/g, '');
                    else if (this.value.startsWith('@')) this.value = '@' + this.value.substring(1).replace(/[^a-zA-Z0-9_]/g, '');
                });
            }
            if (registerFormEl) {
                registerFormEl.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const username = usernameInputEl.value; const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value; const confirmPassword = document.getElementById('confirmPassword').value;
                    if (!username || !email || !password || !confirmPassword) { alert("الرجاء ملء جميع الحقول."); return; }
                    if (!username.startsWith('@') || username.length <= 1) { alert("معرف المستخدم يجب أن يبدأ بـ @ وأن يحتوي على أحرف بعد العلامة."); usernameInputEl.focus(); return; }
                    const usernamePattern = /^@[a-zA-Z0-9_]{3,20}$/;
                    if (!usernamePattern.test(username)) { alert("معرف المستخدم غير صالح (3-20 حرفًا، أرقام، حروف، '_')."); usernameInputEl.focus(); return; }
                    if (password !== confirmPassword) { alert("كلمات المرور غير متطابقة."); return; }
                    
                    myUserInfo.name = username; 
                    myUserInfo.avatar = `https://via.placeholder.com/100/25D366/FFFFFF?text=${username.substring(1,3).toUpperCase()}`; 
                    myUserInfo.statusText = "مرحباً! أنا أستخدم Talkgram."; 
                    initializeMyUserInfo(); 
                    
                    console.log("Register - Username:", username, "Email:", email);
                    alert("تم إنشاء الحساب بنجاح (محاكاة)!");
                    showPage('chatsPage'); renderStatusTab();
                });
            }
            const loginFormEl = document.getElementById('loginForm');
            const loginIdentifierInputEl = document.getElementById('loginIdentifier');
            if (loginIdentifierInputEl) loginIdentifierInputEl.addEventListener('input', function() { this.classList.toggle('username-style', this.value.startsWith('@')); });
            if (loginFormEl) {
                loginFormEl.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const identifier = loginIdentifierInputEl.value; const passwordLogin = document.getElementById('passwordLogin').value;
                    if (!identifier || !passwordLogin) { alert("الرجاء إدخال المعرف وكلمة المرور."); return; }
                    
                    if (identifier.startsWith('@')) myUserInfo.name = identifier;
                    else myUserInfo.name = "مستخدم مسجل"; 
                    myUserInfo.avatar = `https://via.placeholder.com/100/128C7E/FFFFFF?text=${myUserInfo.name.substring(0,2).toUpperCase()}`;
                    myUserInfo.statusText = "متصل الآن";
                    initializeMyUserInfo();

                    console.log("Login - Identifier:", identifier);
                    alert("تم تسجيل الدخول بنجاح (محاكاة)!");
                    showPage('chatsPage'); renderStatusTab();
                });
            }
        }

        function logout() {
            myUserInfo = { name: "اسمك الافتراضي", avatar: "https://via.placeholder.com/100/075E54/FFFFFF?text=??", statusText: "متاح" };
            myStatuses = [];
            sampleGroups = []; 
            saveStatusesToLocalStorage();
            localStorage.removeItem('myTalkgramGroups'); 

            alert("تم تسجيل الخروج (محاكاة)!");
            showPage('welcomePage');
            initializeMyUserInfo(); 
            renderChatList(sampleChats.filter(c => !c.isGroup || c.id === 2)); 
        }

        function openEditProfileModal() {
            if (editProfileAvatarPreviewEl) editProfileAvatarPreviewEl.src = myUserInfo.avatar;
            if (editProfileNameInputEl) editProfileNameInputEl.value = myUserInfo.name;
            if (editProfileStatusTextInputEl) editProfileStatusTextInputEl.value = myUserInfo.statusText;
            openModal('editProfileModal');
        }

        function previewEditProfileAvatar(event) {
            const file = event.target.files[0];
            if (file && editProfileAvatarPreviewEl) {
                const reader = new FileReader();
                reader.onload = function(e) { editProfileAvatarPreviewEl.src = e.target.result; }
                reader.readAsDataURL(file);
            }
        }

        function saveProfileChanges() {
            const newName = editProfileNameInputEl.value.trim();
            const newStatusText = editProfileStatusTextInputEl.value.trim();
            const newAvatarSrc = editProfileAvatarPreviewEl.src; 

            if (!newName) { alert("الاسم لا يمكن أن يكون فارغًا."); editProfileNameInputEl.focus(); return; }

            myUserInfo.name = newName;
            myUserInfo.statusText = newStatusText;
            
            if (newAvatarSrc && newAvatarSrc !== myUserInfo.avatar && (newAvatarSrc.startsWith('data:') || editProfileAvatarFileEl.files[0])) { 
                myUserInfo.avatar = newAvatarSrc;
            } else if (!editProfileAvatarFileEl.files[0] && newName !== myUserInfo.name && myUserInfo.avatar.includes('via.placeholder.com')) { 
                 myUserInfo.avatar = `https://via.placeholder.com/100/25D366/FFFFFF?text=${newName.substring(0,2).toUpperCase()}`;
            }
            
            console.log("Profile Updated:", myUserInfo);
            initializeMyUserInfo(); 

            closeModal('editProfileModal');
            alert("تم حفظ تغييرات الملف الشخصي بنجاح (محاكاة)!");
        }

        function renderEmojiPicker() {
            if (!emojiPickerEl) return;
            emojiPickerEl.innerHTML = ''; 
            commonEmojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji;
                emojiSpan.onclick = () => insertEmoji(emoji);
                emojiPickerEl.appendChild(emojiSpan);
            });
        }

        function toggleEmojiPicker() {
            if (!emojiPickerEl) return;
            const isHidden = emojiPickerEl.style.display === 'none' || emojiPickerEl.style.display === '';
            emojiPickerEl.style.display = isHidden ? 'grid' : 'none'; 

            if (emojiButtonEl) {
                emojiButtonEl.textContent = isHidden ? '⌨️' : '😊';
            }
            
            const messagesContainer = document.getElementById('messagesList');
            if (messagesContainer) {
                if (isHidden) {
                    messagesContainer.style.marginBottom = `${emojiPickerEl.offsetHeight}px`;
                } else {
                    messagesContainer.style.marginBottom = '0px';
                }
                scrollToBottomMessages();
            }
        }

        function insertEmoji(emoji) {
            if (!messageInputArea) return;
            const start = messageInputArea.selectionStart;
            const end = messageInputArea.selectionEnd;
            const text = messageInputArea.value;
            messageInputArea.value = text.substring(0, start) + emoji + text.substring(end);
            messageInputArea.focus();
            messageInputArea.selectionStart = messageInputArea.selectionEnd = start + emoji.length;
            autoResizeTextarea.call(messageInputArea); 
        }

        function triggerImageUpload() {
            if (imageUploadInputEl) {
                imageUploadInputEl.click(); 
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    addMessageToChat({ type: 'image', content: imageDataUrl, text: '' }, true); 
                    setTimeout(() => {
                        const randomImageUrl = `https://picsum.photos/seed/${Date.now()}/300/200`; 
                        addMessageToChat({ type: 'image', content: randomImageUrl, text: 'صورة رائعة!' }, false);
                    }, 1500 + Math.random() * 1000);
                }
                reader.readAsDataURL(file);
            } else if (file) {
                alert("الرجاء اختيار ملف صورة صالح.");
            }
            if (imageUploadInputEl) imageUploadInputEl.value = null;
        }

        function handleHeaderCameraClick() {
            if (statusImageFileEl) {
                statusImageFileEl.value = null; 

                const tempImageHandler = (event) => {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageDataUrl = e.target.result;
                            if (statusImagePreviewEl && statusTextEl) {
                                statusImagePreviewEl.src = imageDataUrl;
                                statusImagePreviewEl.style.display = 'block';
                                statusTextEl.value = ''; 
                                statusTextEl.placeholder = "أضف تعليقًا... (اختياري)"; 
                                openModal('createStatusModal');
                            } else {
                                console.error("عناصر نافذة إنشاء الحالة مفقودة.");
                            }
                        }
                        reader.readAsDataURL(file);
                    } else if (file) {
                        alert("الرجاء اختيار ملف صورة صالح.");
                    }
                    statusImageFileEl.removeEventListener('change', tempImageHandler);
                };
                statusImageFileEl.addEventListener('change', tempImageHandler);
                statusImageFileEl.click(); 
            } else {
                alert("عنصر رفع صور الحالة غير موجود.");
            }
        }

        function openCreateGroupModal() {
            if (groupMembersSelectionEl) {
                groupMembersSelectionEl.innerHTML = ''; 
                if (sampleChats.length > 0) {
                    let availableContacts = 0;
                    sampleChats.forEach(chat => {
                        if (!chat.isGroup && chat.name !== myUserInfo.name) { 
                            availableContacts++;
                            const memberDiv = document.createElement('div');
                            memberDiv.classList.add('member-selection-item');
                            memberDiv.innerHTML = `
                                <input type="checkbox" id="member-${chat.id}" value="${escapeHTML(chat.name)}" data-avatar="${escapeHTML(chat.avatar)}">
                                <label for="member-${chat.id}">${escapeHTML(chat.name)}</label>
                            `;
                            groupMembersSelectionEl.appendChild(memberDiv);
                        }
                    });
                    if(availableContacts === 0) {
                         groupMembersSelectionEl.innerHTML = '<p>لا توجد جهات اتصال فردية لإضافتها.</p>';
                    }
                } else {
                    groupMembersSelectionEl.innerHTML = '<p>لا توجد جهات اتصال متاحة للإضافة.</p>';
                }
            }
            if(groupNameInputEl) groupNameInputEl.value = '';
            if(groupDescriptionInputEl) groupDescriptionInputEl.value = '';
            openModal('createGroupModal');
        }

        function createNewGroup() {
            if (!groupNameInputEl || !groupMembersSelectionEl) return;
            const groupName = groupNameInputEl.value.trim();
            if (!groupName) { alert("اسم المجموعة مطلوب."); groupNameInputEl.focus(); return; }

            const selectedMembersCheckboxes = groupMembersSelectionEl.querySelectorAll('input[type="checkbox"]:checked');
            const selectedMembersData = []; 
            selectedMembersCheckboxes.forEach(checkbox => {
                selectedMembersData.push({name: checkbox.value, avatar: checkbox.dataset.avatar});
            });

            if (selectedMembersData.length === 0) { alert("يجب اختيار عضو واحد على الأقل."); return; }

            const creatorData = {name: myUserInfo.name, avatar: myUserInfo.avatar};
            if (!selectedMembersData.find(m => m.name === creatorData.name)) {
                selectedMembersData.unshift(creatorData); 
            }

            const newGroupId = 'group-' + Date.now();
            const newGroupAvatar = `https://via.placeholder.com/48/8E44AD/FFFFFF?text=${groupName.substring(0,2).toUpperCase()}`;
            
            const newGroup = {
                id: newGroupId,
                name: groupName,
                description: groupDescriptionInputEl.value.trim(),
                avatar: newGroupAvatar,
                members: selectedMembersData, 
                lastMessage: "تم إنشاء المجموعة.",
                time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                unread: 0,
                isGroup: true, 
                onlineStatus: `${selectedMembersData.length} أعضاء` 
            };

            sampleGroups.push(newGroup); 
            sampleChats.unshift(newGroup); 
            
            renderChatList(sampleChats); 
            closeModal('createGroupModal');
            alert(`تم إنشاء مجموعة "${groupName}" بنجاح!`);
            
            const chatsTabButton = document.querySelector('.tab-item[onclick*="chatsTabContent"]');
            if(chatsTabButton) switchTab(chatsTabButton, 'chatsTabContent');
        }

        function initiateCall(callType) {
            if (!onCallPageEl) { console.error("On Call Page element not found!"); return; }

            const contactName = document.getElementById('chatDetailName').textContent;
            const contactAvatar = document.getElementById('chatDetailAvatar').src;
            currentCallType = callType;

            if (onCallContactNameEl) onCallContactNameEl.textContent = contactName;
            if (onCallContactAvatarEl) onCallContactAvatarEl.src = contactAvatar;
            if (onCallStatusEl) onCallStatusEl.textContent = "جاري الاتصال...";
            if (onCallTimerEl) { onCallTimerEl.textContent = "00:00"; onCallTimerEl.style.display = 'none'; }
            
            if (toggleVideoButtonEl) {
                toggleVideoButtonEl.style.display = (callType === 'video') ? 'flex' : 'none';
                isVideoOn = (callType === 'video'); 
                updateCallButtonAppearance(toggleVideoButtonEl, isVideoOn, '📸', '📷'); 
            }
            isMuted = false; isSpeakerOn = false;
            if(toggleMuteButtonEl) updateCallButtonAppearance(toggleMuteButtonEl, isMuted, '🔇', '🎤'); 
            if(toggleSpeakerButtonEl) updateCallButtonAppearance(toggleSpeakerButtonEl, isSpeakerOn, '🔈', '🔊'); 
            showPage('onCallPage'); 
            setTimeout(() => {
                if (onCallStatusEl) onCallStatusEl.textContent = "متصل";
                if (onCallTimerEl) onCallTimerEl.style.display = 'block';
                startCallTimer();
            }, 2000 + Math.random() * 2000); 
        }

        function startCallTimer() {
            callDurationSeconds = 0;
            if (callTimerInterval) clearInterval(callTimerInterval); 
            callTimerInterval = setInterval(() => {
                callDurationSeconds++;
                const minutes = Math.floor(callDurationSeconds / 60);
                const seconds = callDurationSeconds % 60;
                if (onCallTimerEl) {
                    onCallTimerEl.textContent = 
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }, 1000);
        }

        function endCall() {
            if (callTimerInterval) clearInterval(callTimerInterval);
            if (onCallStatusEl) onCallStatusEl.textContent = "انتهت المكالمة";
            setTimeout(() => {
                // Check if chatDetailPage is the active one before trying to go back to it.
                // Otherwise, default to chatsPage. This handles calls initiated from places other than chatDetail if any.
                let previousPage = 'chatsPage'; // Default fallback
                const activePages = document.querySelectorAll('.page.active');
                // Typically only one page is active. If chatDetailPage was active before onCallPage, it might still be in the DOM.
                // A more robust way would be to store the previous page ID before showing onCallPage.
                // For now, we assume if chatDetailPage is in the DOM and onCallPage was shown, chatDetailPage was likely the origin.
                if (document.getElementById('chatDetailPage').contains(onCallPageEl.previousElementSibling) || 
                    (activePages.length > 1 && activePages[0].id === 'chatDetailPage' && activePages[1].id === 'onCallPage') ) {
                     // This logic is a bit fragile. A proper navigation stack would be better.
                     // Simplification: always try to go to chatDetailPage if it exists, else chatsPage
                     if(document.getElementById('chatDetailName').textContent){ // Check if a chat is loaded
                         previousPage = 'chatDetailPage';
                     }
                }
                showPage(previousPage); 
            }, 1500); 
        }

        function toggleMute() {
            isMuted = !isMuted;
            if(toggleMuteButtonEl) updateCallButtonAppearance(toggleMuteButtonEl, isMuted, '🔇', '🎤');
            console.log(isMuted ? "Call Muted" : "Call Unmuted");
        }

        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            if(toggleSpeakerButtonEl) updateCallButtonAppearance(toggleSpeakerButtonEl, isSpeakerOn, '🔊', '🔈');
            console.log(isSpeakerOn ? "Speaker On" : "Speaker Off");
        }
        
        function toggleVideo() {
            if (currentCallType !== 'video') return; 
            isVideoOn = !isVideoOn;
            if(toggleVideoButtonEl) updateCallButtonAppearance(toggleVideoButtonEl, isVideoOn, '📸', '📷'); 
            console.log(isVideoOn ? "Video On" : "Video Off");
        }

        function updateCallButtonAppearance(buttonEl, isActive, activeIcon, inactiveIcon) {
            if (!buttonEl) return;
            buttonEl.classList.toggle('active', isActive);
            const iconEl = buttonEl.querySelector('.icon');
            if(iconEl) iconEl.textContent = isActive ? activeIcon : inactiveIcon;
        }

        // New functions for Message Options (Added in this update)
        function openMessageOptions(messageElement) {
            selectedMessageElement = messageElement;
            openModal('messageOptionsModal');
        }

        function replyToMessage() {
            if (selectedMessageElement) {
                const messageText = selectedMessageElement.dataset.messageText;
                alert(`محاكاة: الرد على الرسالة "${messageText}"`);
                // هنا يمكنك إضافة منطق الرد الفعلي، مثل وضع النص في حقل الإدخال مع إشارة
            }
            closeModal('messageOptionsModal');
        }

        function copyMessageText() {
            if (selectedMessageElement) {
                const messageText = selectedMessageElement.dataset.messageText;
                navigator.clipboard.writeText(messageText)
                    .then(() => {
                        alert("تم نسخ الرسالة!");
                    })
                    .catch(err => {
                        console.error('فشل في نسخ الرسالة:', err);
                        alert("فشل في نسخ الرسالة.");
                    });
            }
            closeModal('messageOptionsModal');
        }

        function deleteMessage() {
            if (selectedMessageElement && confirm("هل أنت متأكد من حذف هذه الرسالة؟")) {
                selectedMessageElement.remove();
                alert("تم حذف الرسالة!");
            }
            closeModal('messageOptionsModal');
        }

    </script>
</body>
</html>
